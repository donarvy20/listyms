<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Evaluación de Estudiantes</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Utility classes for page display */
        .page-content {
            display: none;
        }
        .page-content.active {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 text-gray-900 flex flex-col">

    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-700 to-blue-800 text-white shadow-md p-4 flex items-center justify-between sticky top-0 z-10 rounded-b-lg">
        <h1 class="text-xl md:text-3xl font-bold">
            Gestión de Evaluación de Estudiantes
        </h1>
        <!-- Hamburger menu button -->
        <button id="menu-toggle" class="md:hidden p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white" aria-label="Toggle navigation menu">
            <svg id="menu-icon-open" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7">
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
            <svg id="menu-icon-close" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7 hidden">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <!-- Desktop Navigation -->
        <nav id="desktop-nav" class="hidden md:flex space-x-4">
            <button id="nav-basicData" class="px-4 py-2 rounded-md transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Datos Básicos
            </button>
            <button id="nav-studentManagement" class="px-4 py-2 rounded-md transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                Estudiantes
            </button>
            <button id="nav-checklistManagement" class="px-4 py-2 rounded-md transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <path d="M12 2v4"></path>
                    <path d="M12 16l2 2 4-4"></path>
                    <path d="M8 8H6"></path>
                    <path d="M8 12H6"></path>
                    <path d="M8 16H6"></path>
                </svg>
                Listas de Cotejo
            </button>
            <button id="nav-evaluation" class="px-4 py-2 rounded-md transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Evaluación
            </button>
            <button id="nav-reportModule" class="px-4 py-2 rounded-md transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <line x1="10" y1="9" x2="8" y2="9"></line>
                </svg>
                Reportes
            </button>
        </nav>
    </header>

    <!-- Mobile Navigation (Hamburger Menu) -->
    <nav id="mobile-nav" class="md:hidden bg-indigo-700 text-white shadow-lg py-2 rounded-b-lg hidden">
        <ul class="flex flex-col items-start px-4">
            <li>
                <button data-page="basicData" class="block w-full text-left py-2 px-3 rounded-md hover:bg-indigo-600 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Datos Básicos
                </button>
            </li>
            <li>
                <button data-page="studentManagement" class="block w-full text-left py-2 px-3 rounded-md hover:bg-indigo-600 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Gestión de Estudiantes
                </button>
            </li>
            <li>
                <button data-page="checklistManagement" class="block w-full text-left py-2 px-3 rounded-md hover:bg-indigo-600 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                        <path d="M12 2v4"></path>
                        <path d="M12 16l2 2 4-4"></path>
                        <path d="M8 8H6"></path>
                        <path d="M8 12H6"></path>
                        <path d="M8 16H6"></path>
                    </svg>
                    Listas de Cotejo
                </button>
            </li>
            <li>
                <button data-page="evaluation" class="block w-full text-left py-2 px-3 rounded-md hover:bg-indigo-600 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Módulo de Evaluación
                </button>
            </li>
            <li>
                <button data-page="reportModule" class="block w-full text-left py-2 px-3 rounded-md hover:bg-indigo-600 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <line x1="10" y1="9" x2="8" y2="9"></line>
                    </svg>
                    Reportes Docente
                </button>
            </li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 p-4 md:p-8">
        <h2 id="page-title" class="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 border-indigo-300 pb-2"></h2>
        <div id="content-area">
            <!-- Page content will be rendered here by JavaScript -->
            <div id="basicData-page" class="page-content"></div>
            <div id="studentManagement-page" class="page-content"></div>
            <div id="checklistManagement-page" class="page-content"></div>
            <div id="evaluation-page" class="page-content"></div>
            <div id="reportModule-page" class="page-content"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center p-4 rounded-t-lg">
        <p>&copy; <span id="current-year"></span> Aplicación de Evaluación de Estudiantes. Desarrollado por YJMS. Todos los derechos reservados.</p>
    </footer>

    <script>
        // Global State Variables
        let basicData = {};
        let students = [];
        let checklists = [];
        let evaluations = [];
        let selectedGroupId = '';
        let selectedChecklistId = '';
        let currentPage = 'basicData'; // Initial page
        let arePdfLibsLoaded = false;
        let editingChecklistId = null; // For checklist editing state
        let editingEvaluationId = null; // For evaluation editing state

        // Page Titles Mapping
        const pageTitles = {
            basicData: 'Datos Básicos',
            studentManagement: 'Gestión de Estudiantes',
            checklistManagement: 'Listas de Cotejo',
            evaluation: 'Módulo de Evaluación',
            reportModule: 'Reportes Docente'
        };

        // Utility: Generate UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- Local Storage Management ---
        function loadDataFromLocalStorage() {
            const storedBasicData = localStorage.getItem('evaluationApp_basicData');
            if (storedBasicData) basicData = JSON.parse(storedBasicData);

            const storedStudents = localStorage.getItem('evaluationApp_students');
            if (storedStudents) students = JSON.parse(storedStudents);

            const storedChecklists = localStorage.getItem('evaluationApp_checklists');
            if (storedChecklists) checklists = JSON.parse(storedChecklists);

            const storedEvaluations = localStorage.getItem('evaluationApp_evaluations');
            if (storedEvaluations) evaluations = JSON.parse(storedEvaluations);

            const storedSelectedGroupId = localStorage.getItem('evaluationApp_selectedGroupId');
            if (storedSelectedGroupId) selectedGroupId = storedSelectedGroupId;

            const storedSelectedChecklistId = localStorage.getItem('evaluationApp_selectedChecklistId');
            if (storedSelectedChecklistId) selectedChecklistId = storedSelectedChecklistId;
        }

        function saveDataToLocalStorage() {
            localStorage.setItem('evaluationApp_basicData', JSON.stringify(basicData));
            localStorage.setItem('evaluationApp_students', JSON.stringify(students));
            localStorage.setItem('evaluationApp_checklists', JSON.stringify(checklists));
            localStorage.setItem('evaluationApp_evaluations', JSON.stringify(evaluations));
            localStorage.setItem('evaluationApp_selectedGroupId', selectedGroupId);
            localStorage.setItem('evaluationApp_selectedChecklistId', selectedChecklistId);
        }

        // --- Message Display Utility ---
        function displayMessage(containerId, text, type) {
            const container = document.getElementById(containerId);
            if (!container) return;
            let messageDiv = container.querySelector('.message-alert');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.className = 'message-alert p-3 mb-4 rounded-md';
                container.prepend(messageDiv);
            }
            messageDiv.textContent = text;
            messageDiv.className = `message-alert p-3 mb-4 rounded-md ${type === 'success' ? 'bg-green-100 text-green-700' : (type === 'error' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700')}`;
            // Optional: Hide message after some time
            setTimeout(() => {
                if (messageDiv && messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }


        // --- Render Functions for Each Page ---

        function renderPage() {
            // Hide all pages first
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));

            // Show the active page
            const activePageElement = document.getElementById(`${currentPage}-page`);
            if (activePageElement) {
                activePageElement.classList.add('active');
                document.getElementById('page-title').textContent = pageTitles[currentPage];
            }

            // Call specific render function for the active page
            switch (currentPage) {
                case 'basicData':
                    renderBasicDataPage();
                    break;
                case 'studentManagement':
                    renderStudentManagementPage();
                    break;
                case 'checklistManagement':
                    renderChecklistManagementPage();
                    break;
                case 'evaluation':
                    renderEvaluationModulePage();
                    break;
                case 'reportModule':
                    renderReportModulePage();
                    break;
            }

            // Update navigation button styles
            document.querySelectorAll('nav button').forEach(button => {
                const buttonPage = button.id ? button.id.replace('nav-', '') : button.dataset.page;
                if (buttonPage === currentPage) {
                    button.classList.add('bg-white', 'text-indigo-700', 'font-semibold', 'shadow');
                    button.classList.remove('text-white', 'hover:bg-indigo-600');
                } else {
                    button.classList.remove('bg-white', 'text-indigo-700', 'font-semibold', 'shadow');
                    button.classList.add('text-white', 'hover:bg-indigo-600');
                }
            });
        }

        // --- Basic Data Module ---
        function renderBasicDataPage() {
            const pageDiv = document.getElementById('basicData-page');
            pageDiv.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Datos Básicos</h2>
                    <div id="basic-data-message-container"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label htmlFor="institution" class="block text-sm font-medium text-gray-700">Nombre de la Institución:</label>
                            <input type="text" id="institution" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
                        </div>
                        <div>
                            <label htmlFor="course" class="block text-sm font-medium text-gray-700">Curso:</label>
                            <input type="text" id="course" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
                        </div>
                        <div>
                            <label htmlFor="teacher" class="block text-sm font-medium text-gray-700">Docente:</label>
                            <input type="text" id="teacher" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
                        </div>
                        <div>
                            <label htmlFor="date" class="block text-sm font-medium text-gray-700">Fecha:</label>
                            <input type="date" id="date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
                        </div>
                        <div class="md:col-span-2">
                            <label htmlFor="session" class="block text-sm font-medium text-gray-700">Nombre de la Sesión de Aprendizaje:</label>
                            <input type="text" id="session" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ej: Sesión 1 - Matemática" />
                        </div>
                    </div>
                    <button id="save-basic-data" class="w-full md:w-auto px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-md shadow-md hover:from-blue-600 hover:to-indigo-700 transition duration-300 ease-in-out transform hover:scale-105">
                        Guardar Datos Básicos
                    </button>
                </div>
            `;

            // Populate fields with current data
            document.getElementById('institution').value = basicData.institutionName || '';
            document.getElementById('course').value = basicData.courseName || '';
            document.getElementById('teacher').value = basicData.teacherName || '';
            document.getElementById('date').value = basicData.date || new Date().toISOString().split('T')[0];
            document.getElementById('session').value = basicData.learningSessionName || '';

            // Add event listener
            document.getElementById('save-basic-data').onclick = () => {
                basicData = {
                    institutionName: document.getElementById('institution').value,
                    courseName: document.getElementById('course').value,
                    teacherName: document.getElementById('teacher').value,
                    date: document.getElementById('date').value,
                    learningSessionName: document.getElementById('session').value
                };
                saveDataToLocalStorage();
                displayMessage('basic-data-message-container', "Datos básicos guardados correctamente.", 'success');
            };
        }

        // --- Student Management Module ---
        function renderStudentManagementPage() {
            const pageDiv = document.getElementById('studentManagement-page');
            pageDiv.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Gestión de Estudiantes</h2>
                    <div id="student-management-message-container"></div>
                    <div class="mb-4">
                        <label htmlFor="studentData" class="block text-sm font-medium text-gray-700 mb-2">
                            Copia y pega los datos de los estudiantes (Nombre Completo - separados por tabulador, coma o punto y coma). Opcionalmente, añade el Grupo:
                        </label>
                        <textarea id="studentData" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm h-32" placeholder="Ej:&#10;Juan Pérez&#9;Inicial I&#10;Maria García&#9;Matemática V"></textarea>
                        <div class="mt-4">
                            <label htmlFor="studentGroup" class="block text-sm font-medium text-gray-700">Grupo General para todos los estudiantes a añadir (Opcional):</label>
                            <input type="text" id="studentGroup" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ej: Inicial I" />
                        </div>
                    </div>
                    <button id="add-students-btn" class="w-full md:w-auto px-6 py-2 bg-gradient-to-r from-green-500 to-teal-600 text-white font-semibold rounded-md shadow-md hover:from-green-600 hover:to-teal-700 transition duration-300 ease-in-out transform hover:scale-105 mb-6">
                        Agregar Estudiantes
                    </button>

                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Grupos Existentes:</h3>
                    <div id="grouped-students-list" class="divide-y divide-gray-300 border border-gray-200 rounded-md mb-6"></div>

                    <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-700">Gestionar Grupos:</h3>
                    <div class="border p-4 rounded-md bg-gray-50 mb-6">
                        <div class="mb-4">
                            <label htmlFor="selectGroupToManage" class="block text-sm font-medium text-gray-700">Seleccionar Grupo:</label>
                            <select id="selectGroupToManage" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                        </div>
                        <div class="mb-4">
                            <label htmlFor="newGroupNameToRename" class="block text-sm font-medium text-gray-700">Nuevo Nombre del Grupo (para renombrar):</label>
                            <input type="text" id="newGroupNameToRename" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ej: Nuevo Grupo de Inicial I" disabled />
                        </div>
                        <div class="flex flex-col md:flex-row gap-4">
                            <button id="rename-group-btn" class="flex-1 px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-md shadow-md hover:from-blue-600 hover:to-indigo-700 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Renombrar Grupo
                            </button>
                            <button id="delete-group-btn" class="flex-1 px-6 py-2 bg-gradient-to-r from-red-500 to-rose-600 text-white font-semibold rounded-md shadow-md hover:from-red-600 hover:to-rose-700 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Eliminar Grupo
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const studentDataInput = document.getElementById('studentData');
            const studentGroupInput = document.getElementById('studentGroup');
            const addStudentsBtn = document.getElementById('add-students-btn');
            const groupedStudentsList = document.getElementById('grouped-students-list');
            const selectGroupToManage = document.getElementById('selectGroupToManage');
            const newGroupNameToRenameInput = document.getElementById('newGroupNameToRename');
            const renameGroupBtn = document.getElementById('rename-group-btn');
            const deleteGroupBtn = document.getElementById('delete-group-btn');

            addStudentsBtn.onclick = () => {
                const lines = studentDataInput.value.split('\n').filter(line => line.trim() !== '');
                const newStudentsToAdd = [];

                for (const line of lines) {
                    let fullName = '';
                    let group = studentGroupInput.value.trim();
                    let dni = generateUUID().substring(0, 8);

                    let parts = line.split('\t').map(p => p.trim());
                    if (parts.length >= 1) {
                        fullName = parts[0];
                        if (parts.length >= 2) {
                            group = parts[1];
                        }
                    } else {
                        parts = line.split(',').map(p => p.trim());
                        if (parts.length >= 1) {
                            fullName = parts[0];
                            if (parts.length >= 2) {
                                group = parts[1];
                            }
                        } else {
                            parts = line.split(';').map(p => p.trim());
                            if (parts.length >= 1) {
                                fullName = parts[0];
                                if (parts.length >= 2) {
                                    group = parts[1];
                                }
                            } else {
                                fullName = line.trim();
                            }
                        }
                    }

                    if (fullName) {
                        if (!students.some(s => s.fullName === fullName && s.group === group)) {
                            newStudentsToAdd.push({ id: generateUUID(), dni, fullName, group });
                        } else {
                            console.log(`Estudiante con nombre completo '${fullName}' y grupo '${group}' ya existe, omitiendo.`);
                        }
                    }
                }

                if (newStudentsToAdd.length === 0) {
                    displayMessage('student-management-message-container', 'No se encontraron estudiantes válidos para agregar o ya existen. Asegúrate de que los datos estén en formato Nombre Completo[tab]Grupo, o Nombre Completo,Grupo, o Nombre Completo;Grupo. El campo Grupo es opcional en la línea, pero puedes definir un grupo general arriba.', 'error');
                    return;
                }

                students = [...students, ...newStudentsToAdd];
                studentDataInput.value = '';
                saveDataToLocalStorage();
                displayMessage('student-management-message-container', `Se agregaron ${newStudentsToAdd.length} estudiantes nuevos.`, 'success');
                renderStudentManagementPage(); // Re-render to update the lists
            };

            const groupedStudents = students.reduce((acc, student) => {
                const groupName = student.group || 'Sin Grupo';
                if (!acc[groupName]) {
                    acc[groupName] = [];
                }
                acc[groupName].push(student);
                return acc;
            }, {});

            const uniqueGroups = [...new Set(students.map(student => student.group || 'Sin Grupo'))].sort((a, b) => {
                if (a === 'Sin Grupo') return 1;
                if (b === 'Sin Grupo') return -1;
                return a.localeCompare(b);
            });

            if (uniqueGroups.length === 0) {
                groupedStudentsList.innerHTML = '<p class="text-gray-500 p-4">No hay grupos registrados.</p>';
                selectGroupToManage.innerHTML = '<option value="">-- Selecciona un Grupo --</option>';
            } else {
                groupedStudentsList.innerHTML = uniqueGroups.map(groupName => `
                    <div class="p-4 bg-gray-100 last:rounded-b-md">
                        <div class="flex justify-between items-center">
                            <h4 class="text-lg font-semibold text-gray-800">
                                ${groupName} <span class="font-normal text-gray-600">(${groupedStudents[groupName]?.length || 0} estudiantes)</span>
                            </h4>
                        </div>
                    </div>
                `).join('');

                selectGroupToManage.innerHTML = '<option value="">-- Selecciona un Grupo --</option>' + uniqueGroups.map(group => `
                    <option value="${group}">${group}</option>
                `).join('');
            }

            selectGroupToManage.onchange = () => {
                const selectedGroup = selectGroupToManage.value;
                setSelectedGroupToManage(selectedGroup);
                newGroupNameToRenameInput.value = selectedGroup;
                newGroupNameToRenameInput.disabled = !selectedGroup;
                renameGroupBtn.disabled = !selectedGroup || !newGroupNameToRenameInput.value.trim() || selectedGroup === newGroupNameToRenameInput.value.trim();
                deleteGroupBtn.disabled = !selectedGroup;
            };

            newGroupNameToRenameInput.oninput = () => {
                renameGroupBtn.disabled = !selectedGroupToManage || !newGroupNameToRenameInput.value.trim() || selectedGroupToManage === newGroupNameToRenameInput.value.trim();
            };

            renameGroupBtn.onclick = () => {
                const oldGroupName = selectGroupToManage.value;
                const newGroupName = newGroupNameToRenameInput.value.trim();

                if (!oldGroupName || !newGroupName) {
                    displayMessage('student-management-message-container', 'Por favor, selecciona un grupo y proporciona un nuevo nombre.', 'error');
                    return;
                }
                if (oldGroupName === newGroupName) {
                    displayMessage('student-management-message-container', 'El nuevo nombre del grupo es el mismo que el actual.', 'info');
                    return;
                }
                if (uniqueGroups.includes(newGroupName)) {
                    displayMessage('student-management-message-container', `Ya existe un grupo con el nombre "${newGroupName}".`, 'error');
                    return;
                }

                students = students.map(student =>
                    (student.group || 'Sin Grupo') === oldGroupName
                        ? { ...student, group: newGroupName }
                        : student
                );
                evaluations = evaluations.map(evalItem =>
                    (evalItem.studentGroup || 'Sin Grupo') === oldGroupName
                        ? { ...evalItem, studentGroup: newGroupName }
                        : evalItem
                );

                saveDataToLocalStorage();
                displayMessage('student-management-message-container', `Grupo "${oldGroupName}" renombrado a "${newGroupName}" correctamente.`, 'success');
                selectedGroupToManage = '';
                newGroupNameToRenameInput.value = '';
                renderStudentManagementPage();
            };

            deleteGroupBtn.onclick = () => {
                const groupToDelete = selectGroupToManage.value;
                if (!groupToDelete) {
                    displayMessage('student-management-message-container', 'Por favor, selecciona un grupo para eliminar.', 'error');
                    return;
                }

                const studentsInDeletedGroupIds = students
                    .filter(student => (student.group || 'Sin Grupo') === groupToDelete)
                    .map(student => student.id);

                students = students.filter(student => (student.group || 'Sin Grupo') !== groupToDelete);
                evaluations = evaluations.filter(evalItem => !studentsInDeletedGroupIds.includes(evalItem.studentId));

                saveDataToLocalStorage();
                displayMessage('student-management-message-container', `Grupo "${groupToDelete}" y todos sus estudiantes y evaluaciones asociadas eliminados correctamente.`, 'success');
                selectedGroupToManage = '';
                newGroupNameToRenameInput.value = '';
                renderStudentManagementPage();
            };

            // Initial state for buttons
            newGroupNameToRenameInput.disabled = !selectedGroupToManage;
            renameGroupBtn.disabled = !selectedGroupToManage || !newGroupNameToRenameInput.value.trim() || selectedGroupToManage === newGroupNameToRenameInput.value.trim();
            deleteGroupBtn.disabled = !selectedGroupToManage;
        }

        // --- Checklist Management Module ---
        function renderChecklistManagementPage() {
            const pageDiv = document.getElementById('checklistManagement-page');
            pageDiv.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Gestión de Listas de Cotejo</h2>
                    <div id="checklist-management-message-container"></div>
                    <div class="mb-6 border p-4 rounded-md bg-gray-50">
                        <label htmlFor="checklistName" class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Lista de Cotejo:</label>
                        <input type="text" id="checklistName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />

                        <h3 class="text-lg font-semibold mt-4 mb-2 text-gray-700">Criterios a Evaluar:</h3>
                        <div id="criteria-list"></div>
                        <button id="add-criterion-btn" class="mt-2 px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600 transition duration-300 ease-in-out transform hover:scale-105">
                            Agregar Criterio
                        </button>

                        <h3 class="text-lg font-semibold mt-6 mb-2 text-gray-700">Niveles de Evaluación y Puntajes:</h3>
                        <div id="levels-list"></div>
                    </div>
                    <div class="flex gap-4">
                        <button id="save-checklist-btn" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-600 text-white font-semibold rounded-md shadow-md hover:from-purple-600 hover:to-pink-700 transition duration-300 ease-in-out transform hover:scale-105">
                            Guardar Lista de Cotejo
                        </button>
                        <button id="cancel-edit-checklist-btn" class="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-md shadow-md hover:bg-gray-400 transition duration-300 ease-in-out transform hover:scale-105 hidden">
                            Cancelar Edición
                        </button>
                    </div>

                    <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-700">Listas de Cotejo Existentes:</h3>
                    <ul id="existing-checklists-list" class="divide-y divide-gray-200 border border-gray-200 rounded-md"></ul>
                </div>
            `;

            const checklistNameInput = document.getElementById('checklistName');
            const criteriaListDiv = document.getElementById('criteria-list');
            const addCriterionBtn = document.getElementById('add-criterion-btn');
            const levelsListDiv = document.getElementById('levels-list');
            const saveChecklistBtn = document.getElementById('save-checklist-btn');
            const cancelEditChecklistBtn = document.getElementById('cancel-edit-checklist-btn');
            const existingChecklistsList = document.getElementById('existing-checklists-list');

            let currentCriteria = [{ id: generateUUID(), name: '' }];
            let currentLevels = [
                { id: 'l1', name: 'Previo al Inicio', score: 1 },
                { id: 'l2', name: 'Inicio', score: 2 },
                { id: 'l3', name: 'Proceso', score: 3 },
                { id: 'l4', name: 'Logrado', score: 4 },
                { id: 'l5', name: 'Destacado', score: 5 }
            ];

            const renderCriteria = () => {
                criteriaListDiv.innerHTML = currentCriteria.map((criterion, index) => `
                    <div class="flex items-center mb-2">
                        <input type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${criterion.name}" placeholder="Criterio ${index + 1}" data-criterion-id="${criterion.id}" />
                        ${currentCriteria.length > 1 ? `<button data-remove-criterion-id="${criterion.id}" class="ml-2 p-2 text-red-600 hover:text-red-800 rounded-full focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50" aria-label="Eliminar criterio">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>` : ''}
                    </div>
                `).join('');

                criteriaListDiv.querySelectorAll('input[data-criterion-id]').forEach(input => {
                    input.oninput = (e) => {
                        const id = e.target.dataset.criterionId;
                        const newName = e.target.value;
                        currentCriteria = currentCriteria.map(c => c.id === id ? { ...c, name: newName } : c);
                    };
                });
                criteriaListDiv.querySelectorAll('button[data-remove-criterion-id]').forEach(button => {
                    button.onclick = (e) => {
                        const id = e.currentTarget.dataset.removeCriterionId;
                        currentCriteria = currentCriteria.filter(c => c.id !== id);
                        renderCriteria();
                    };
                });
            };

            const renderLevels = () => {
                levelsListDiv.innerHTML = currentLevels.map(level => `
                    <div class="flex items-center mb-2 gap-2">
                        <input type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${level.name}" placeholder="Nombre del Nivel" data-level-id="${level.id}" data-field="name" />
                        <input type="number" class="mt-1 block w-24 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${level.score}" placeholder="Puntaje" min="0" step="0.1" data-level-id="${level.id}" data-field="score" />
                    </div>
                `).join('');

                levelsListDiv.querySelectorAll('input[data-level-id]').forEach(input => {
                    input.oninput = (e) => {
                        const id = e.target.dataset.levelId;
                        const field = e.target.dataset.field;
                        const value = e.target.value;
                        currentLevels = currentLevels.map(l => l.id === id ? { ...l, [field]: field === 'score' ? parseFloat(value) || 0 : value } : l);
                    };
                });
            };

            const resetForm = () => {
                checklistNameInput.value = '';
                currentCriteria = [{ id: generateUUID(), name: '' }];
                currentLevels = [
                    { id: 'l1', name: 'Previo al Inicio', score: 1 },
                    { id: 'l2', name: 'Inicio', score: 2 },
                    { id: 'l3', name: 'Proceso', score: 3 },
                    { id: 'l4', name: 'Logrado', score: 4 },
                    { id: 'l5', name: 'Destacado', score: 5 }
                ];
                editingChecklistId = null;
                saveChecklistBtn.textContent = 'Guardar Lista de Cotejo';
                cancelEditChecklistBtn.classList.add('hidden');
                renderCriteria();
                renderLevels();
            };

            const handleSaveChecklist = () => {
                const validCriteria = currentCriteria.filter(c => c.name.trim() !== '');
                if (!checklistNameInput.value.trim() || validCriteria.length === 0) {
                    displayMessage('checklist-management-message-container', 'El nombre de la lista y al menos un criterio son obligatorios.', 'error');
                    return;
                }

                const checklistData = {
                    id: editingChecklistId || generateUUID(),
                    name: checklistNameInput.value,
                    criteria: validCriteria,
                    levels: currentLevels
                };

                if (editingChecklistId) {
                    checklists = checklists.map(cl => cl.id === editingChecklistId ? checklistData : cl);
                    displayMessage('checklist-management-message-container', 'Lista de cotejo actualizada correctamente.', 'success');
                } else {
                    checklists = [...checklists, checklistData];
                    displayMessage('checklist-management-message-container', 'Lista de cotejo guardada correctamente.', 'success');
                }
                saveDataToLocalStorage();
                resetForm();
                renderExistingChecklists();
            };

            const handleEditChecklist = (id) => {
                const checklistToEdit = checklists.find(cl => cl.id === id);
                if (checklistToEdit) {
                    editingChecklistId = checklistToEdit.id;
                    checklistNameInput.value = checklistToEdit.name;
                    currentCriteria = JSON.parse(JSON.stringify(checklistToEdit.criteria)); // Deep copy
                    currentLevels = JSON.parse(JSON.stringify(checklistToEdit.levels)); // Deep copy
                    saveChecklistBtn.textContent = 'Actualizar Lista';
                    cancelEditChecklistBtn.classList.remove('hidden');
                    renderCriteria();
                    renderLevels();
                }
            };

            const handleDeleteChecklist = (id) => {
                checklists = checklists.filter(checklist => checklist.id !== id);
                saveDataToLocalStorage();
                displayMessage('checklist-management-message-container', 'Lista de cotejo eliminada.', 'success');
                renderExistingChecklists();
                resetForm(); // Reset form if the deleted checklist was being edited
            };

            const renderExistingChecklists = () => {
                if (checklists.length === 0) {
                    existingChecklistsList.innerHTML = '<li class="p-3 text-gray-500">No hay listas de cotejo creadas.</li>';
                } else {
                    existingChecklistsList.innerHTML = checklists.map(checklist => `
                        <li class="p-4 flex flex-wrap justify-between items-center bg-gray-50 hover:bg-gray-100">
                            <span class="text-gray-800 font-medium text-lg mb-2 md:mb-0">${checklist.name}</span>
                            <div class="flex flex-col md:flex-row gap-2">
                                <button data-edit-id="${checklist.id}" class="p-2 text-blue-600 hover:text-blue-800 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" aria-label="Editar lista">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button data-delete-id="${checklist.id}" class="p-2 text-red-600 hover:text-red-800 rounded-full focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50" aria-label="Eliminar lista">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        </li>
                    `).join('');

                    existingChecklistsList.querySelectorAll('button[data-edit-id]').forEach(button => {
                        button.onclick = (e) => handleEditChecklist(e.currentTarget.dataset.editId);
                    });
                    existingChecklistsList.querySelectorAll('button[data-delete-id]').forEach(button => {
                        button.onclick = (e) => handleDeleteChecklist(e.currentTarget.dataset.deleteId);
                    });
                }
            };

            // Initial render calls
            renderCriteria();
            renderLevels();
            renderExistingChecklists();

            // Event listeners
            addCriterionBtn.onclick = () => {
                currentCriteria.push({ id: generateUUID(), name: '' });
                renderCriteria();
            };
            saveChecklistBtn.onclick = handleSaveChecklist;
            cancelEditChecklistBtn.onclick = resetForm;

            // Initialize form fields
            if (editingChecklistId) {
                const checklistToEdit = checklists.find(cl => cl.id === editingChecklistId);
                if (checklistToEdit) {
                    checklistNameInput.value = checklistToEdit.name;
                    currentCriteria = JSON.parse(JSON.stringify(checklistToEdit.criteria));
                    currentLevels = JSON.parse(JSON.stringify(checklistToEdit.levels));
                    saveChecklistBtn.textContent = 'Actualizar Lista';
                    cancelEditChecklistBtn.classList.remove('hidden');
                }
            } else {
                checklistNameInput.value = '';
                saveChecklistBtn.textContent = 'Guardar Lista de Cotejo';
                cancelEditChecklistBtn.classList.add('hidden');
            }
            renderCriteria();
            renderLevels();
        }


        // --- Evaluation Module ---
        function renderEvaluationModulePage() {
            const pageDiv = document.getElementById('evaluation-page');
            pageDiv.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Módulo de Evaluación</h2>
                    <div id="evaluation-message-container"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label htmlFor="selectGroup" class="block text-sm font-medium text-gray-700">Seleccionar Grupo:</label>
                            <select id="selectGroup" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                        </div>
                        <div>
                            <label htmlFor="selectChecklist" class="block text-sm font-medium text-gray-700">Seleccionar Lista de Cotejo:</label>
                            <select id="selectChecklist" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                        </div>
                        <div class="md:col-span-2">
                            <label htmlFor="selectStudent" class="block text-sm font-medium text-gray-700">Seleccionar Estudiante:</label>
                            <select id="selectStudent" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                        </div>
                    </div>

                    <div id="evaluation-form-content">
                        <!-- Dynamic content for evaluation will be loaded here -->
                    </div>
                </div>
            `;

            const selectGroup = document.getElementById('selectGroup');
            const selectChecklist = document.getElementById('selectChecklist');
            const selectStudent = document.getElementById('selectStudent');
            const evaluationFormContent = document.getElementById('evaluation-form-content');

            let currentChecklist = null;
            let evaluationScores = {}; // { criterionId: levelId }
            let totalScore = 0;
            let average = 0;
            let qualitativeRating = '';
            let selectedStudentIdLocal = ''; // Use local variable for state within this render

            const levelColorClasses = {
                'l1': 'bg-orange-500 hover:bg-orange-600 text-white',
                'l2': 'bg-yellow-500 hover:bg-yellow-600 text-white',
                'l3': 'bg-green-500 hover:bg-green-600 text-white',
                'l4': 'bg-blue-400 hover:bg-blue-500 text-white',
                'l5': 'bg-blue-700 hover:bg-blue-800 text-white',
            };

            const isStudentEvaluated = (studentId) => {
                return evaluations.some(evalItem => evalItem.studentId === studentId);
            };

            const uniqueGroups = [...new Set(students.map(student => student.group || 'Sin Grupo'))].sort();

            const renderSelectOptions = () => {
                selectGroup.innerHTML = '<option value="">-- Selecciona un Grupo --</option>' +
                    uniqueGroups.map(group => `<option value="${group}" ${selectedGroupId === group ? 'selected' : ''}>${group}</option>`).join('');

                selectChecklist.innerHTML = '<option value="">-- Selecciona una Lista de Cotejo --</option>' +
                    checklists.map(checklist => `<option value="${checklist.id}" ${selectedChecklistId === checklist.id ? 'selected' : ''}>${checklist.name}</option>`).join('');

                const filteredStudents = selectedGroupId
                    ? students.filter(student => (student.group || 'Sin Grupo') === selectedGroupId)
                    : [];
                
                selectStudent.innerHTML = '<option value="">-- Selecciona un Estudiante --</option>' +
                    filteredStudents.map(student => `
                        <option value="${student.id}" ${selectedStudentIdLocal === student.id ? 'selected' : ''}>
                            ${student.fullName} ${isStudentEvaluated(student.id) ? ' - Evaluado' : ''}
                        </option>
                    `).join('');
                selectStudent.disabled = !selectedGroupId || filteredStudents.length === 0;
            };

            const calculateScores = () => {
                if (!currentChecklist) {
                    totalScore = 0;
                    average = 0;
                    qualitativeRating = '';
                    return;
                }

                let calculatedTotalScore = 0;
                let evaluatedCriteriaCount = 0;

                currentChecklist.criteria.forEach(criterion => {
                    const selectedLevelId = evaluationScores[criterion.id];
                    if (selectedLevelId) {
                        const level = currentChecklist.levels.find(l => l.id === selectedLevelId);
                        if (level) {
                            calculatedTotalScore += level.score;
                            evaluatedCriteriaCount++;
                        }
                    }
                });

                totalScore = calculatedTotalScore;
                average = evaluatedCriteriaCount > 0 ? parseFloat((calculatedTotalScore / evaluatedCriteriaCount).toFixed(1)) : 0;

                let rating = '';
                if (average >= 0 && average < 2) {
                    rating = 'Previo al Inicio';
                } else if (average >= 2 && average < 3) {
                    rating = 'Inicio';
                } else if (average >= 3 && average < 4) {
                    rating = 'Proceso';
                } else if (average >= 4 && average < 5) {
                    rating = 'Logrado';
                } else if (average === 5) {
                    rating = 'Destacado';
                }
                qualitativeRating = rating;
            };

            const renderEvaluationForm = () => {
                if (!selectedStudentIdLocal || !selectedChecklistId || !currentChecklist) {
                    evaluationFormContent.innerHTML = '';
                    return;
                }

                const student = students.find(s => s.id === selectedStudentIdLocal);
                if (!student) {
                    evaluationFormContent.innerHTML = '';
                    return;
                }

                const criteriaHtml = currentChecklist.criteria.map(criterion => `
                    <div class="mb-4">
                        <p class="font-medium text-gray-800">${criterion.name}:</p>
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${currentChecklist.levels.map(level => `
                                <button type="button" data-criterion-id="${criterion.id}" data-level-id="${level.id}"
                                    class="px-4 py-2 rounded-md shadow-md transition duration-300 ease-in-out transform hover:scale-105
                                    ${levelColorClasses[level.id] || 'bg-gray-200 text-gray-800 hover:bg-gray-300'}
                                    ${evaluationScores[criterion.id] === level.id ? 'ring-2 ring-offset-2 ring-indigo-500' : ''}"
                                >
                                    ${level.name} (${level.score})
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                evaluationFormContent.innerHTML = `
                    <div class="border p-4 rounded-md bg-gray-50 mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">Evaluando a: <span class="text-blue-700">${student.fullName}</span> con la lista "<span class="text-blue-700">${currentChecklist.name}</span>"</h3>
                        ${criteriaHtml}
                        <div class="mt-6 p-4 border-t border-gray-200 pt-4">
                            <p class="text-lg font-semibold text-gray-800">Puntaje Total: <span class="text-green-600">${totalScore.toFixed(1)}</span></p>
                            <p class="text-lg font-semibold text-gray-800">Promedio: <span class="text-green-600">${average.toFixed(1)}</span></p>
                            <p class="text-lg font-semibold text-gray-800">Calificación Cualitativa: <span class="text-purple-600">${qualitativeRating}</span></p>
                        </div>
                        <div class="flex gap-4 mt-6">
                            <button id="reset-evaluation-btn" class="flex-1 px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-md shadow-md hover:bg-gray-400 transition duration-300 ease-in-out transform hover:scale-105">
                                Reiniciar Formulario
                            </button>
                        </div>
                        <div class="flex justify-between gap-4 mt-4">
                            <button id="prev-student-btn" class="flex-1 px-6 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                Estudiante Anterior
                            </button>
                            <button id="next-student-btn" class="flex-1 px-6 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                Siguiente Estudiante
                            </button>
                        </div>
                    </div>
                `;

                // Add event listeners for level selection buttons
                evaluationFormContent.querySelectorAll('button[data-criterion-id]').forEach(button => {
                    button.onclick = (e) => {
                        const criterionId = e.target.dataset.criterionId;
                        const levelId = e.target.dataset.levelId;
                        handleEvaluationChange(criterionId, levelId); // Call the change handler which now saves
                    };
                });

                document.getElementById('reset-evaluation-btn').onclick = handleResetForm;
                document.getElementById('prev-student-btn').onclick = handlePreviousStudent;
                document.getElementById('next-student-btn').onclick = handleNextStudent;

                // Disable/enable navigation buttons
                const filteredStudents = selectedGroupId ? students.filter(s => (s.group || 'Sin Grupo') === selectedGroupId) : [];
                const currentStudentIndex = filteredStudents.findIndex(s => s.id === selectedStudentIdLocal);
                document.getElementById('prev-student-btn').disabled = currentStudentIndex === 0;
                document.getElementById('next-student-btn').disabled = currentStudentIndex === filteredStudents.length - 1;
            };

            const handleEvaluationChange = (criterionId, levelId) => {
                evaluationScores = { ...evaluationScores, [criterionId]: levelId };
                calculateScores();
                renderEvaluationForm(); // Re-render to update button styles and scores
                handleSaveEvaluation(); // Automatically save after a change
            };

            const handleSaveEvaluation = () => {
                if (!selectedStudentIdLocal || !selectedChecklistId || !currentChecklist) {
                    // displayMessage('evaluation-message-container', 'Por favor, selecciona un estudiante y una lista de cotejo.', 'error');
                    return; // Don't show error if nothing selected, just don't save
                }

                const student = students.find(s => s.id === selectedStudentIdLocal);
                if (!student) {
                    displayMessage('evaluation-message-container', 'Estudiante no encontrado.', 'error');
                    return;
                }

                const allEvaluated = currentChecklist.criteria.every(c => evaluationScores[c.id]);
                if (!allEvaluated) {
                    // Only display a message if all criteria are not met, but don't prevent saving partials if user navigates away.
                    // This is more of a warning for the user than a hard block.
                    // displayMessage('evaluation-message-container', 'Por favor, evalúa todos los criterios antes de guardar.', 'info');
                    // return; // Do not return here, allow partial save
                }

                const evaluationData = {
                    id: editingEvaluationId || generateUUID(),
                    studentId: selectedStudentIdLocal,
                    studentFullName: student.fullName,
                    studentGroup: student.group || '',
                    checklistId: selectedChecklistId,
                    checklistName: currentChecklist.name,
                    date: new Date().toISOString().split('T')[0],
                    scores: currentChecklist.criteria.map(criterion => {
                        const selectedLevelId = evaluationScores[criterion.id];
                        const level = currentChecklist.levels.find(l => l.id === selectedLevelId);
                        return {
                            criterionId: criterion.id,
                            criterionName: criterion.name,
                            levelId: selectedLevelId,
                            levelName: level ? level.name : 'N/A',
                            score: level ? level.score : 0
                        };
                    }),
                    totalScore: totalScore,
                    average: average,
                    qualitativeRating: qualitativeRating
                };

                if (editingEvaluationId) {
                    evaluations = evaluations.map(e => e.id === editingEvaluationId ? evaluationData : e);
                    displayMessage('evaluation-message-container', 'Evaluación actualizada automáticamente.', 'success');
                } else {
                    evaluations = [...evaluations, evaluationData];
                    displayMessage('evaluation-message-container', 'Evaluación guardada automáticamente.', 'success');
                }
                saveDataToLocalStorage();
                renderSelectOptions(); // Update student list in case evaluated status changed
            };

            const handleResetForm = () => {
                selectedStudentIdLocal = '';
                evaluationScores = {};
                totalScore = 0;
                average = 0;
                qualitativeRating = '';
                editingEvaluationId = null;
                displayMessage('evaluation-message-container', 'Formulario de evaluación reiniciado. Selecciona un estudiante para continuar.', 'info');
                renderEvaluationForm(); // Clear the form content
                renderSelectOptions(); // Reset student selection
            };

            const handleNextStudent = () => {
                const filteredStudents = selectedGroupId ? students.filter(s => (s.group || 'Sin Grupo') === selectedGroupId) : [];
                const currentStudentIndex = filteredStudents.findIndex(s => s.id === selectedStudentIdLocal);
                if (currentStudentIndex < filteredStudents.length - 1) {
                    selectedStudentIdLocal = filteredStudents[currentStudentIndex + 1].id;
                    updateEvaluationFormForSelectedStudent();
                } else {
                    displayMessage('evaluation-message-container', 'No hay más estudiantes en este grupo.', 'info');
                }
            };

            const handlePreviousStudent = () => {
                const filteredStudents = selectedGroupId ? students.filter(s => (s.group || 'Sin Grupo') === selectedGroupId) : [];
                const currentStudentIndex = filteredStudents.findIndex(s => s.id === selectedStudentIdLocal);
                if (currentStudentIndex > 0) {
                    selectedStudentIdLocal = filteredStudents[currentStudentIndex - 1].id;
                    updateEvaluationFormForSelectedStudent();
                } else {
                    displayMessage('evaluation-message-container', 'No hay estudiantes anteriores en este grupo.', 'info');
                }
            };

            const updateEvaluationFormForSelectedStudent = () => {
                if (selectedStudentIdLocal && selectedChecklistId) {
                    currentChecklist = checklists.find(c => c.id === selectedChecklistId);

                    const existingEvaluation = evaluations.find(
                        e => e.studentId === selectedStudentIdLocal && e.checklistId === selectedChecklistId
                    );

                    if (existingEvaluation) {
                        editingEvaluationId = existingEvaluation.id;
                        evaluationScores = {};
                        existingEvaluation.scores.forEach(s => {
                            evaluationScores[s.criterionId] = s.levelId;
                        });
                        displayMessage('evaluation-message-container', 'Evaluación existente cargada para edición.', 'success');
                    } else if (currentChecklist) {
                        editingEvaluationId = null;
                        evaluationScores = {};
                        currentChecklist.criteria.forEach(c => evaluationScores[c.id] = '');
                        totalScore = 0;
                        average = 0;
                        qualitativeRating = '';
                        displayMessage('evaluation-message-container', '', ''); // Clear message
                    }
                } else {
                    currentChecklist = null;
                    evaluationScores = {};
                    totalScore = 0;
                    average = 0;
                    qualitativeRating = '';
                    editingEvaluationId = null;
                    displayMessage('evaluation-message-container', '', ''); // Clear message
                }
                calculateScores();
                renderEvaluationForm();
            };

            // Event Listeners for dropdowns
            selectGroup.onchange = (e) => {
                selectedGroupId = e.target.value;
                selectedStudentIdLocal = ''; // Reset student selection when group changes
                saveDataToLocalStorage();
                renderSelectOptions();
                updateEvaluationFormForSelectedStudent(); // Update form if needed
            };

            selectChecklist.onchange = (e) => {
                selectedChecklistId = e.target.value;
                saveDataToLocalStorage();
                updateEvaluationFormForSelectedStudent();
            };

            selectStudent.onchange = (e) => {
                selectedStudentIdLocal = e.target.value;
                updateEvaluationFormForSelectedStudent();
            };

            // Initial render calls
            renderSelectOptions();
            updateEvaluationFormForSelectedStudent(); // Call this to set initial form state based on loaded data
        }


        // --- Report Module ---
        function renderReportModulePage() {
            const pageDiv = document.getElementById('reportModule-page');
            pageDiv.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Módulo de Reportes (Docente)</h2>
                    <div id="report-module-message-container"></div>

                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Generar Reportes Individuales por Estudiante:</h3>
                    <div class="mb-4">
                        <label htmlFor="selectGroupForIndividualReports" class="block text-sm font-medium text-gray-700">Seleccionar Grupo para Reportes Individuales:</label>
                        <select id="selectGroupForIndividualReports" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                    </div>
                    <ul id="individual-reports-list" class="divide-y divide-gray-200 border border-gray-200 rounded-md mb-6"></ul>
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <button id="generate-all-individual-reports-btn" class="flex-1 px-6 py-2 bg-gradient-to-r from-green-600 to-lime-700 text-white font-semibold rounded-md shadow-md hover:from-green-700 hover:to-lime-800 transition duration-300 ease-in-out transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Generar Todos los Reportes Individuales del Grupo Seleccionado
                        </button>
                    </div>

                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Generar Reporte Resumen (Registro Auxiliar):</h3>
                    <div class="mb-4">
                        <label htmlFor="selectGroupForSummary" class="block text-sm font-medium text-gray-700">Seleccionar Grupo para Reporte Resumen:</label>
                        <select id="selectGroupForSummary" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <button id="generate-summary-report-btn" class="flex-1 px-6 py-2 bg-gradient-to-r from-yellow-500 to-orange-600 text-white font-semibold rounded-md shadow-md hover:from-yellow-600 hover:to-orange-700 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <line x1="10" y1="9" x2="8" y2="9"></line>
                            </svg>
                            Generar Reporte Resumen del Grupo Seleccionado
                        </button>
                        <button id="generate-all-summary-reports-btn" class="flex-1 px-6 py-2 bg-gradient-to-r from-purple-500 to-red-600 text-white font-semibold rounded-md shadow-md hover:from-purple-600 hover:to-red-700 transition duration-300 ease-in-out transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Generar Reportes Resumen de Todos los Grupos
                        </button>
                    </div>
                    <p class="mt-8 text-sm text-gray-600">
                        <span class="font-bold">Nota importante sobre la seguridad:</span> Este reporte es para el estudiante. Para una protección con contraseña real que cifre el archivo PDF, se requeriría un procesamiento en un servidor, algo que esta aplicación, al ser de solo navegador, no puede ofrecer.
                    </p>
                </div>
            `;

            const selectGroupForIndividualReports = document.getElementById('selectGroupForIndividualReports');
            const individualReportsList = document.getElementById('individual-reports-list');
            const generateAllIndividualReportsBtn = document.getElementById('generate-all-individual-reports-btn');
            const selectGroupForSummary = document.getElementById('selectGroupForSummary');
            const generateSummaryReportBtn = document.getElementById('generate-summary-report-btn');
            const generateAllSummaryReportsBtn = document.getElementById('generate-all-summary-reports-btn');


            const uniqueGroups = [...new Set(students.map(student => student.group || 'Sin Grupo'))].sort();

            const renderIndividualReportsList = () => {
                const selectedGroup = selectGroupForIndividualReports.value;
                const filteredStudents = selectedGroup
                    ? students.filter(student => (student.group || 'Sin Grupo') === selectedGroup)
                    : students;

                if (filteredStudents.length === 0) {
                    individualReportsList.innerHTML = '<p class="text-gray-500 p-4">No hay estudiantes en el grupo seleccionado o no hay estudiantes para generar reportes.</p>';
                    generateAllIndividualReportsBtn.disabled = true;
                } else {
                    individualReportsList.innerHTML = filteredStudents.map(student => `
                        <li class="p-4 flex flex-col md:flex-row justify-between items-start md:items-center bg-gray-50 hover:bg-gray-100">
                            <span class="text-gray-800 font-medium mb-2 md:mb-0">${student.fullName} ${student.group ? ` - Grupo: ${student.group}` : ''}</span>
                            <button data-student-id="${student.id}" class="generate-individual-pdf-btn px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold rounded-md shadow-md hover:from-indigo-600 hover:to-purple-700 transition duration-300 ease-in-out transform hover:scale-105">
                                Generar PDF
                            </button>
                        </li>
                    `).join('');
                    generateAllIndividualReportsBtn.disabled = false;

                    individualReportsList.querySelectorAll('.generate-individual-pdf-btn').forEach(button => {
                        button.onclick = async (e) => {
                            const studentId = e.currentTarget.dataset.studentId;
                            const student = students.find(s => s.id === studentId);
                            if (student) await handleGenerateIndividualReport(student);
                        };
                    });
                }
            };

            const populateGroupSelects = () => {
                const groupOptions = '<option value="">-- Todos los Grupos --</option>' + uniqueGroups.map(group => `
                    <option value="${group}">${group}</option>
                `).join('');
                selectGroupForIndividualReports.innerHTML = groupOptions;
                selectGroupForSummary.innerHTML = '<option value="">-- Seleccionar Grupo --</option>' + uniqueGroups.map(group => `
                    <option value="${group}">${group}</option>
                `).join('');
            };

            // Event Listeners
            selectGroupForIndividualReports.onchange = renderIndividualReportsList;
            selectGroupForSummary.onchange = (e) => {
                const selected = e.target.value;
                generateSummaryReportBtn.disabled = !selected;
            };

            generateAllIndividualReportsBtn.onclick = async () => {
                if (!arePdfLibsLoaded) {
                    displayMessage('report-module-message-container', 'Las librerías de PDF aún no están cargadas. Por favor, inténtalo de nuevo en unos segundos.', 'error');
                    return;
                }
                const selectedGroup = selectGroupForIndividualReports.value;
                const studentsToReport = selectedGroup
                    ? students.filter(student => (student.group || 'Sin Grupo') === selectedGroup)
                    : students;
                if (studentsToReport.length === 0) {
                    displayMessage('report-module-message-container', 'No hay estudiantes en el grupo seleccionado para generar reportes.', 'error');
                    return;
                }

                displayMessage('report-module-message-container', 'Generando reportes individuales para todos los estudiantes del grupo seleccionado. Esto puede tardar un momento...', 'info');
                for (const student of studentsToReport) {
                    await handleGenerateIndividualReport(student);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                displayMessage('report-module-message-container', 'Todos los reportes individuales han sido generados.', 'success');
            };

            generateSummaryReportBtn.onclick = async () => {
                const selectedGroup = selectGroupForSummary.value;
                if (!selectedGroup) {
                    displayMessage('report-module-message-container', 'Por favor, selecciona un grupo para generar el reporte resumen.', 'error');
                    return;
                }
                await handleGenerateSummaryReport(selectedGroup);
            };

            generateAllSummaryReportsBtn.onclick = async () => {
                await handleGenerateSummaryReport(null); // Pass null to indicate all groups
            };

            const handleGenerateIndividualReport = async (student) => {
                if (!arePdfLibsLoaded) {
                    displayMessage('report-module-message-container', 'Las librerías de PDF aún no están cargadas. Por favor, inténtalo de nuevo en unos segundos.', 'error');
                    return;
                }

                displayMessage('report-module-message-container', `Generando reporte para ${student.fullName}, por favor espera...`, 'info');

                const studentEvaluations = evaluations.filter(e => e.studentId === student.id);

                if (studentEvaluations.length === 0) {
                    displayMessage('report-module-message-container', `No hay calificaciones para ${student.fullName}.`, 'error');
                    return;
                }

                const pdfContentId = 'individual-pdf-content';
                let tempDiv = document.createElement('div');
                tempDiv.id = pdfContentId;
                tempDiv.style.padding = '10mm'; // Reduce padding slightly
                tempDiv.style.width = '280mm'; // Approx A4 landscape width (297mm - 17mm margins)
                tempDiv.style.boxSizing = 'border-box';
                tempDiv.className = 'bg-white rounded-lg shadow-lg text-sm'; // Smaller text to fit more

                let evaluationsDetailsHtml = '';

                // Outer table for all evaluations
                evaluationsDetailsHtml += `
                    <table class="min-w-full bg-white border border-gray-300 rounded-md shadow-sm mt-4">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Lista de Cotejo</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Fecha</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Promedio</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Calificación Cualitativa</th>
                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Detalle de Criterios</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                studentEvaluations.forEach(evalItem => {
                    let criterionDetailsTable = `
                        <table class="min-w-full text-xs"> <!-- Smaller font for inner table -->
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="py-1 px-2 border-b text-left font-semibold text-gray-700">Criterio</th>
                                    <th class="py-1 px-2 border-b text-left font-semibold text-gray-700">Nivel</th>
                                    <th class="py-1 px-2 border-b text-left font-semibold text-gray-700">Puntaje</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    evalItem.scores.forEach(scoreItem => {
                        // Determine background color based on level name
                        let bgColorClass = '';
                        switch (scoreItem.levelName) {
                            case 'Previo al Inicio':
                                bgColorClass = 'bg-orange-200'; // Lighter orange
                                break;
                            case 'Inicio':
                                bgColorClass = 'bg-yellow-200'; // Lighter yellow
                                break;
                            case 'Proceso':
                                bgColorClass = 'bg-green-200'; // Lighter green
                                break;
                            case 'Logrado':
                                bgColorClass = 'bg-blue-200'; // Lighter blue
                                break;
                            case 'Destacado':
                                bgColorClass = 'bg-blue-500 text-white'; // Darker blue with white text
                                break;
                            default:
                                bgColorClass = 'bg-gray-100'; // Default
                        }

                        criterionDetailsTable += `
                            <tr class="${bgColorClass}">
                                <td class="py-1 px-2 border-b text-gray-800">${scoreItem.criterionName}</td>
                                <td class="py-1 px-2 border-b text-gray-800">${scoreItem.levelName}</td>
                                <td class="py-1 px-2 border-b text-gray-800">${scoreItem.score}</td>
                            </tr>
                        `;
                    });
                    criterionDetailsTable += `</tbody></table>`;


                    evaluationsDetailsHtml += `
                        <tr class="hover:bg-gray-50 align-top"> <!-- Align to top for multi-line cells -->
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${evalItem.checklistName}</td>
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${evalItem.date}</td>
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${evalItem.average.toFixed(1)}</td>
                            <td class="py-2 px-4 border-b text-sm text-gray-800">${evalItem.qualitativeRating}</td>
                            <td class="py-2 px-4 border-b text-sm text-gray-800">
                                <p class="text-sm font-semibold mb-2">Puntaje Total de Lista: ${evalItem.totalScore.toFixed(1)}</p>
                                ${criterionDetailsTable}
                            </td>
                        </tr>
                    `;
                });

                evaluationsDetailsHtml += `</tbody></table>`;

                tempDiv.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Reporte de Calificaciones Individual</h2>
                    <div class="mb-4 text-sm text-gray-600 text-left">
                        ${basicData.institutionName ? `<p><span class="font-semibold">Institución:</span> ${basicData.institutionName}</p>` : ''}
                        ${basicData.courseName ? `<p><span class="font-semibold">Curso:</span> ${basicData.courseName}</p>` : ''}
                        ${basicData.teacherName ? `<p><span class="font-semibold">Docente:</span> ${basicData.teacherName}</p>` : ''}
                        ${basicData.date ? `<p><span class="font-semibold">Fecha del Reporte:</span> ${basicData.date}</p>` : ''}
                        ${basicData.learningSessionName ? `<p><span class="font-semibold">Nombre de la Sesión de Aprendizaje:</span> "${basicData.learningSessionName}"</p>` : ''}
                    </div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Estudiante: ${student.fullName} ${student.group ? `(Grupo: ${student.group})` : ''}</h3>
                    ${evaluationsDetailsHtml}
                `;

                document.body.appendChild(tempDiv);

                try {
                    const jsPDF = window.jspdf.jsPDF || window.jspdf.default || window.jsPDF;
                    // Changed to landscape 'l'
                    const pdf = new jsPDF('l', 'mm', 'a4');
                    // Use a higher scale to get more content on one page, but also ensure layout is responsive
                    const canvas = await window.html2canvas(tempDiv, { scale: 3, logging: true, useCORS: true });
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);

                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;

                    const pdfPageWidth = pdf.internal.pageSize.getWidth(); // This will be 297mm for landscape A4
                    const pdfPageHeight = pdf.internal.pageSize.getHeight(); // This will be 210mm for landscape A4

                    const widthRatio = pdfPageWidth / imgWidth;
                    const finalImgWidth = pdfPageWidth;
                    const finalImgHeight = imgHeight * widthRatio;

                    // Check if content fits on a single page based on calculated height
                    if (finalImgHeight > pdfPageHeight) {
                        // If it still overflows, try to adjust the image to fit one page by scaling down further.
                        // This might make the text very small if there's a lot of content.
                        const heightRatio = pdfPageHeight / finalImgHeight;
                        const adjustedScale = widthRatio * heightRatio; // New scale to fit height
                        const adjustedImgWidth = imgWidth * adjustedScale;
                        const adjustedImgHeight = imgHeight * adjustedScale;

                        pdf.addImage(imgData, 'JPEG', (pdfPageWidth - adjustedImgWidth) / 2, (pdfPageHeight - adjustedImgHeight) / 2, adjustedImgWidth, adjustedImgHeight);
                        displayMessage('report-module-message-container', 'Reporte PDF generado y descargado correctamente. La información se ha escalado para ajustarse a una sola página.', 'success');
                    } else {
                        pdf.addImage(imgData, 'JPEG', 0, 0, finalImgWidth, finalImgHeight);
                        displayMessage('report-module-message-container', 'Reporte PDF generado y descargado correctamente.', 'success');
                    }

                    pdf.save(`Reporte_Calificaciones_${student.fullName.replace(/\s+/g, '_')}.pdf`);

                } catch (error) {
                    console.error("Error al generar PDF individual:", error);
                    displayMessage('report-module-message-container', 'Error al generar el reporte PDF. Asegúrate de que no haya demasiado contenido para una sola página.', 'error');
                } finally {
                    if (document.body.contains(tempDiv)) {
                        document.body.removeChild(tempDiv);
                    }
                }
            };

            const handleGenerateSummaryReport = async (groupName = null) => {
                if (!arePdfLibsLoaded) {
                    displayMessage('report-module-message-container', 'Las librerías de PDF aún no están cargadas. Por favor, inténtalo de nuevo en unos segundos.', 'error');
                    return;
                }
                if (students.length === 0) {
                    displayMessage('report-module-message-container', 'No hay estudiantes para generar el reporte resumen.', 'error');
                    return;
                }

                let groupsToReport = [];
                if (groupName) {
                    groupsToReport = [groupName];
                } else {
                    groupsToReport = uniqueGroups.filter(group => {
                        return students.some(s => (s.group || 'Sin Grupo') === group && evaluations.some(e => e.studentId === s.id));
                    });

                    if (groupsToReport.length === 0) {
                        displayMessage('report-module-message-container', 'No hay grupos con estudiantes evaluados para generar reportes resumen.', 'warning');
                        return;
                    }
                    displayMessage('report-module-message-container', 'Generando reportes resumen para todos los grupos evaluados. Esto puede tardar un momento...', 'info');
                }

                for (const currentGroupName of groupsToReport) {
                    const filteredStudentsForSummary = students.filter(student => (student.group || 'Sin Grupo') === currentGroupName);

                    if (filteredStudentsForSummary.length === 0) {
                        displayMessage('report-module-message-container', `No hay estudiantes en el grupo "${currentGroupName}" para generar el reporte resumen.`, 'warning');
                        continue;
                    }

                    displayMessage('report-module-message-container', `Generando reporte resumen para el grupo "${currentGroupName}", por favor espera...`, 'success');

                    const pdfContentId = 'summary-pdf-content';
                    let tempDiv = document.createElement('div');
                    tempDiv.id = pdfContentId;
                    tempDiv.style.padding = '15mm';
                    tempDiv.style.width = '210mm';
                    tempDiv.style.boxSizing = 'border-box';
                    tempDiv.className = 'bg-white rounded-lg shadow-lg';

                    let summaryTableRows = '';
                    filteredStudentsForSummary.forEach(student => {
                        const studentEvaluations = evaluations.filter(e => e.studentId === student.id);
                        let overallAverage = 0;
                        let overallQualitativeRating = 'N/A';
                        let totalEvaluations = studentEvaluations.length;

                        if (totalEvaluations > 0) {
                            const sumOfAverages = studentEvaluations.reduce((sum, evalItem) => sum + evalItem.average, 0);
                            overallAverage = sumOfAverages / totalEvaluations;

                            if (overallAverage >= 0 && overallAverage < 2) {
                                overallQualitativeRating = 'Previo al Inicio';
                            } else if (overallAverage >= 2 && overallAverage < 3) {
                                overallQualitativeRating = 'Inicio';
                            } else if (overallAverage >= 3 && overallAverage < 4) {
                                overallQualitativeRating = 'Proceso';
                            } else if (overallAverage >= 4 && overallAverage < 5) {
                                overallQualitativeRating = 'Logrado';
                            } else if (overallAverage === 5) {
                                overallQualitativeRating = 'Destacado';
                            }
                        }

                        summaryTableRows += `
                            <tr class="hover:bg-gray-50">
                                <td class="py-2 px-4 border-b text-sm text-gray-800">${student.fullName}</td>
                                <td class="py-2 px-4 border-b text-sm text-gray-800">${student.group || 'Sin Grupo'}</td>
                                <td class="py-2 px-4 border-b text-sm text-gray-800">${overallAverage.toFixed(1)}</td>
                                <td class="py-2 px-4 border-b text-sm text-gray-800">${overallQualitativeRating}</td>
                            </tr>
                        `;
                    });

                    tempDiv.innerHTML = `
                        <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Reporte Resumen de Evaluaciones - Grupo: ${currentGroupName}</h2>
                        <div class="mb-4 text-sm text-gray-600 text-left">
                            ${basicData.institutionName ? `<p><span class="font-semibold">Institución:</span> ${basicData.institutionName}</p>` : ''}
                            ${basicData.courseName ? `<p><span class="font-semibold">Curso:</span> ${basicData.courseName}</p>` : ''}
                            ${basicData.teacherName ? `<p><span class="font-semibold">Docente:</span> ${basicData.teacherName}</p>` : ''}
                            <p><span class="font-semibold">Fecha del Reporte:</span> ${new Date().toISOString().split('T')[0]}</p>
                            ${basicData.learningSessionName ? `<p><span class="font-semibold">Nombre de la Sesión de Aprendizaje:</span> "${basicData.learningSessionName}"</p>` : ''}
                        </div>
                        <table class="min-w-full bg-white border border-gray-300 rounded-md shadow-sm mt-4">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Nombre Completo</th>
                                    <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Grupo</th>
                                    <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Promedio General</th>
                                    <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Calificación Cualitativa</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${summaryTableRows}
                            </tbody>
                        </table>
                    `;

                    document.body.appendChild(tempDiv);

                    try {
                        const jsPDF = window.jspdf.jsPDF || window.jspdf.default || window.jsPDF;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const canvas = await window.html2canvas(tempDiv, { scale: 2 });
                        const imgData = canvas.toDataURL('image/jpeg', 1.0);

                        const imgWidth = canvas.width;
                        const imgHeight = canvas.height;

                        const pdfPageWidth = pdf.internal.pageSize.getWidth();
                        const pdfPageHeight = pdf.internal.pageSize.getHeight();

                        const widthRatio = pdfPageWidth / imgWidth;
                        const finalImgWidth = pdfPageWidth;
                        const finalImgHeight = imgHeight * widthRatio;

                        let heightLeft = finalImgHeight;
                        let position = 0;

                        pdf.addImage(imgData, 'JPEG', 0, position, finalImgWidth, finalImgHeight);
                        heightLeft -= pdfPageHeight;

                        while (heightLeft > 0) {
                            position = heightLeft - finalImgHeight;
                            pdf.addPage();
                            pdf.addImage(imgData, 'JPEG', 0, position, finalImgWidth, finalImgHeight);
                            heightLeft -= pdfPageHeight;
                        }

                        pdf.save(`Reporte_Resumen_Evaluaciones_${currentGroupName.replace(/\s+/g, '_')}.pdf`);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } catch (error) {
                        console.error(`Error al generar reporte resumen PDF para el grupo ${currentGroupName}:`, error);
                        displayMessage('report-module-message-container', `Error al generar el reporte resumen PDF para el grupo "${currentGroupName}".`, 'error');
                    } finally {
                        if (document.body.contains(tempDiv)) {
                            document.body.removeChild(tempDiv);
                        }
                    }
                }
                displayMessage('report-module-message-container', 'Reporte(s) resumen PDF generado(s) y descargado(s) correctamente.', 'success');
            };


            // Initial render
            populateGroupSelects();
            renderIndividualReportsList(); // Initial render for individual reports
            generateSummaryReportBtn.disabled = !selectGroupForSummary.value; // Initial state for summary button
        }


        // --- App Initialization & Navigation ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-year').textContent = new Date().getFullYear();
            loadDataFromLocalStorage(); // Load data on app start
            renderPage(); // Render the initial page

            // Dynamic PDF library loading
            let jspdfLoaded = false;
            let html2canvasLoaded = false;

            const checkAllLoaded = () => {
                if (jspdfLoaded && html2canvasLoaded) {
                    arePdfLibsLoaded = true;
                    console.log('PDF libraries loaded successfully.');
                }
            };

            const loadScript = (src, id, globalVarCheck) => {
                const existingScript = document.getElementById(id);
                if (existingScript) {
                    const checkInterval = setInterval(() => {
                        const isGlobalVarReady = (globalVarCheck === 'jsPDF' && (window.jspdf && (window.jspdf.jsPDF || window.jspdf.default))) ||
                                                 (globalVarCheck === 'html2canvas' && window.html2canvas);
                        if (isGlobalVarReady) {
                            clearInterval(checkInterval);
                            if (id === 'jspdf-script') jspdfLoaded = true;
                            if (id === 'html2canvas-script') html2canvasLoaded = true;
                            checkAllLoaded();
                        }
                    }, 50);
                    return;
                }

                const script = document.createElement('script');
                script.src = src;
                script.id = id;
                script.async = true;
                script.onload = () => {
                    const checkInterval = setInterval(() => {
                        const isGlobalVarReady = (globalVarCheck === 'jsPDF' && (window.jspdf && (window.jspdf.jsPDF || window.jspdf.default))) ||
                                                 (globalVarCheck === 'html2canvas' && window.html2canvas);
                        if (isGlobalVarReady) {
                            clearInterval(checkInterval);
                            if (id === 'jspdf-script') jspdfLoaded = true;
                            if (id === 'html2canvas-script') html2canvasLoaded = true;
                            checkAllLoaded();
                        }
                    }, 50);
                };
                script.onerror = () => {
                    console.error(`Failed to load script: ${src}`);
                };
                document.body.appendChild(script);
            };

            loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', 'jspdf-script', 'jsPDF');
            loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', 'html2canvas-script', 'html2canvas');

            // Navigation event listeners
            document.getElementById('nav-basicData').onclick = () => { currentPage = 'basicData'; renderPage(); };
            document.getElementById('nav-studentManagement').onclick = () => { currentPage = 'studentManagement'; renderPage(); };
            document.getElementById('nav-checklistManagement').onclick = () => { currentPage = 'checklistManagement'; renderPage(); };
            document.getElementById('nav-evaluation').onclick = () => { currentPage = 'evaluation'; renderPage(); };
            document.getElementById('nav-reportModule').onclick = () => { currentPage = 'reportModule'; renderPage(); };

            // Mobile menu toggle
            const menuToggle = document.getElementById('menu-toggle');
            const mobileNav = document.getElementById('mobile-nav');
            const menuIconOpen = document.getElementById('menu-icon-open');
            const menuIconClose = document.getElementById('menu-icon-close');

            menuToggle.onclick = () => {
                mobileNav.classList.toggle('hidden');
                menuIconOpen.classList.toggle('hidden');
                menuIconClose.classList.toggle('hidden');
            };

            // Close mobile menu when a navigation item is clicked
            mobileNav.querySelectorAll('button').forEach(button => {
                button.onclick = (e) => {
                    currentPage = e.currentTarget.dataset.page;
                    mobileNav.classList.add('hidden');
                    menuIconOpen.classList.remove('hidden');
                    menuIconClose.classList.add('hidden');
                    renderPage();
                };
            });
        });

    </script>
</body>
</html>
